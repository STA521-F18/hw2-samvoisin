---
title: "HW2 STA521 Fall18"
author: 'Sam Voisin (netid: psv6, github: samvoisin)'
date: "Due September 23, 2018 5pm"
output:
  html_document:
  html_notebook: default
  pdf_document: default

---

add back to top after done!!!

pdf_document: default
  html_document:
    df_print: paged

## Backgound Reading

Readings: Chapters 3-4 in Weisberg Applied Linear Regression


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This exercise involves the UN data set from `alr3` package. Install `alr3` and the `car` packages and load the data to answer the following questions adding your code in the code chunks.  Please add appropriate code to the chunks to suppress messages and warnings as needed once you are sure the code is working properly and remove instructions if no longer needed. Fig.ures should have informative captions. Please switch the output to pdf for your final version to upload to Sakai. **Remove these instructions for final submission**


## Exploratory Data Analysis

```{r data, include = FALSE}
library(alr3)
library(knitr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(GGally)
library(gridExtra)
library(car)
data(UN3, package="alr3")

print_na_cols <- function(df) {
  # name data frame columns containing NA values
  na_cols <- c()
  
  for (name in names(UN3)) {
    if (any(is.na(UN3[name]))) {
      na_cols <- c(na_cols, name)
    }
  }
  print(na_cols)
}

```


All data is a quantitative measurement in some way. `ModernC`, `Change`, `Frate`, and `Purban` are percentages. `Pop` and `Fertility` are counts. `PPgdp` is a continuous quantitative variable (minus the fact that we can't divide beyond a penny). Below, we can see that `ModernC`, `Change`, `PPgdp`, `Frate`, `Pop`, and `Fertility` all contain `NA` values. This leaves Purban as the only column with no NA values.

```{r Question1, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

str(UN3)

print("Columns with NA values:")
print_na_cols(UN3)


```

2. What is the mean and standard deviation of each quantitative predictor?

```{r Question2, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

col_mean <- round(sapply(UN3, mean, na.rm = TRUE), 2)
col_sd <- round(sapply(UN3, sd, na.rm = TRUE), 2)

kable(
  cbind(col_mean, col_sd),
  col.names = c("Mean", "St Dev")
  )

```


3. Investigate the predictors graphically, using scatterplots or other tools of your choice. Create some plots
highlighting the relationships among the predictors. Comment
on your findings regarding trying to predict `ModernC` from the other variables.  Are there potential outliers, nonlinear relationships or transformations that appear to be needed based on your graphical EDA?

  As a first step, I used the ggpairs to create a matrix of all of the variables. From the plot matrix, it seems there may be two outliers in `Pop`. Fig. 3.1 below shows these points represent China and India. In Fig. 3.2 the relationship between `PPgdp` and `ModernC` shows the highest density of points centered near the y-axis, and the realtionship appears non-linear. This variable may need to be transformed. The next observation I made from the plot matrix is the near linear relationship `Fertility` has with `ModernC` in Fig. 3.3. It is not surprising that there is a relationship here. However, the near linear nature of the realtionship is promising. Finally, `Purban` has an almost linear, positive relationship with `ModernC` (Fig. 3.4).

```{r Question3, message = FALSE, warning = FALSE, echo = FALSE, fig.width= 14, fig.height= 10}

UN3_rmna <- UN3[complete.cases(UN3), ]

ggpairs(UN3_rmna)
  
# create Pop vs ModernC plot
PopModc <- ggplot(data = UN3_rmna, aes(x = Pop, y = ModernC)) + 
  geom_point(size = 2.5) +
  ggtitle("Population vs Modern Contraception %") +
  labs(x = "Population (000s)",
       y = "Access to Contraception (%)",
       subtitle = "Fig. 3.1") +
  geom_text(aes(label = ifelse(Pop > 1000000, row.names(UN3_rmna),''),
                hjust = 1,
                vjust = 2)) +
  theme(plot.title = element_text(size = 18, face = "bold"),
        axis.title = element_text(size = 17),
          axis.text = element_text(size = 18))


# create PPgdp vs ModernC plot
PPgdpModc <- ggplot(data = UN3_rmna, aes(x = PPgdp, y = ModernC)) + 
  geom_point(size = 2.5) +
  ggtitle("Per Capita GDP vs Modern Contraception %") +
  labs(x = "Per Capita GDP (USD)",
       y = "Access to Contraception (%)",
       subtitle = "Fig. 3.2") +
  theme(plot.title = element_text(size = 18, face = "bold"),
        axis.title = element_text(size = 17),
          axis.text = element_text(size = 18))
  

# create ModernC vs Fertility plot
ModcFert <- ggplot(data = UN3_rmna, aes(x = ModernC, y = Fertility)) + 
  geom_point(size = 2.5) +
  ggtitle("Modern Contraception % vs Fertility Rate") +
  labs(x = "Access to Contraception (%)",
       y = "Expected Fertility Rate (# per female)",
       subtitle = "Fig. 3.3") +
  theme(plot.title = element_text(size = 18, face = "bold"),
        axis.title = element_text(size = 17),
          axis.text = element_text(size = 18))


# create ModernC vs Frate
PurbModc <- ggplot(data = UN3_rmna, aes(x = Purban, y = ModernC)) + 
  geom_point(size = 2.5) +
  ggtitle("Urban Population % vs Modern Contraception %") +
  labs(x = "Urban Population (%)",
       y = "Access to Contraception (%)",
       subtitle = "Fig. 3.4") +
  theme(plot.title = element_text(size = 18, face = "bold"),
        axis.title = element_text(size = 17),
        axis.text = element_text(size = 18))

grid.arrange(PopModc, PPgdpModc, ModcFert, PurbModc, ncol = 2)

```

## Model Fitting

4.  Use the `lm()` function to perform a multiple linear regression with `ModernC` as the response and all other variables as the predictors, using the formula `ModernC ~ .`, where the `.` includes all remaining variables in the dataframe.  Create  diagnostic residual plot from the linear model object and comment on results regarding assumptions.  How many observations are used in your model fitting?

There were 125 observations used in fitting this preliminary model after removing of incomplete cases.

From the below residual plots we can see a few issues regarding the three assumptions for linear models. First, it seems that the constant variance assumption is incorrect. We can see this in the Residuals vs Fitted and the Scale-Location graphs. Both seem to fan out slightly over the horizontal axis. From the Normal Q-Q plot we can see that the normality assumption begins to break down at the positive extreme of the normal distribution. Points that theoretically should be in the positive second standard deviation seem to be closer to the first (i.e. the residuals seem to be skewed left). It is worth noting that China and India, while having high leverage, are not outside the contours of Cook's Distance.


```{r Question4, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

PreTMod <- lm(ModernC ~ ., data = UN3_rmna)

par(mfrow=c(2,2))
plot(PreTMod, ask=F)

ggplot(data = PreTMod, aes(x = .resid)) +
  geom_density(size = 2.5) +
  ggtitle("Density of Residuals") +
  labs(x = "Residuals",
       y = "Residual Density",
       subtitle = "Residuals are skewed left as depicted by Normal Q-Q plot") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.title = element_text(size = 20),
        axis.text = element_text(size = 18),
        plot.subtitle = element_text(size = 15))



print("Bonferroni corrected T-test for outliers:")
outlierTest(PreTMod)

```

5. Examine added variable plots `car::avPlot` or `car::avPlots`  for your model above. Are there any plots that suggest that transformations are needed for any of the terms in the model? Describe. Is it likely that any of the localities are influential for any of the terms?  Which localities?  Which terms?

As mentioned previously, China and Inda are the highest leverage values in the third graph of column two, ModernC | others vs Pop | others. However the result of the Bonferroni corrected T-test of the studentized residuals (above) does not result in any t-statistics with a p-value significantly small to reject the null hypothesis $H_0: \mu_i = E[Y|X = x_i]$.

Notably, the added variable plots for `Purban` and `Frate` have slopes near zero meaning that they do not provide unique information regarding the variation in `ModernC` beyond the other predictors. The summary output below confirms this assessment. The T-statistics for both $\hat\beta$ values are not significant. These predictors will be removed from the model.

```{r Question5, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

summary(PreTMod)

avPlots(PreTMod)

outlierTest(PreTMod)

Cook_Dist <- cooks.distance(PreTMod)

Cook_DF <- data.frame(CookD = round(c(Cook_Dist["China"],
                                      Cook_Dist["India"]), 3),
                      row.names = c("China", "India"))

kable(Cook_DF, col.names = "Cook's Distance")

```

6.  Using the Box-Tidwell `car::boxTidwell` or graphical methods find appropriate transformations of the predictor variables to be used as predictors in the linear model.  If any predictors are negative, you may need to transform so that they are non-negative. Describe your method and the resulting transformations.

The first transformation performed was taking the natural log of the `Pop` variable. This brings the data within a single order of magnitude and reduces the leverage of China and India (Fig. 6.1). Next, the Box-Tidwell procedure was performed to test linearity assumptions for the `PPgdp`, `Fertility`, and `Change` predictors. Due to the occasionally negative values of the `Change` predictor, `Change` was shifted in the positive direction via the following formula: $|min(Change)| + 1$. This guarantees the lowest value is $1$ while maintaing the relationship with `ModernC`. the Bonferroni correction used to control the familywise error rate adjusted the significance level to $\alpha = 1.7\%$. The results of the Box-Tidwell test were not significant enough to reject the null $H_0: \lambda = 1$ for `PPgdp` or `Fertility`. The mean-shifted `Change` variable did produce a significant result. However, the maximim likelihood estimate of $\lambda \approx 89$. This result suggests that the Box-Tidwell method should not be used for transforming this variable.

```{r Question6, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

paste("Bonferroni adjustment to 5% significance level (3 hypotheses): alpha =", round(0.05 / 3, 3))

UN3_rmna %>%
  # boxTidwell function cannot take non-pos values
  # shift Change var up by absolute value of min + 1
  mutate(ShiftChange = Change + abs(min(Change)) + 1) %>%
  boxTidwell(ModernC ~ PPgdp + Fertility + ShiftChange,
             other.x = ~ log(Pop),
             verbose = FALSE,
             data = .)

# fit X transformed model
PostXTMod <- lm(ModernC ~ PPgdp +
                Fertility + Change +
                log(Pop),
                data = UN3_rmna)

PopModc <- ggplot(data = UN3_rmna, aes(x = log(Pop), y = ModernC)) + 
  geom_point(size = 2.5) +
  ggtitle("Population vs Modern Contraception %") +
  labs(x = "Log(Population)",
       y = "Access to Contraception (%)",
       subtitle = "Fig. 6.1") +
  theme(plot.title = element_text(size = 18, face = "bold"),
        axis.title = element_text(size = 17),
        axis.text = element_text(size=18))

ModcFert <- ggplot(data = UN3_rmna, aes(x = Fertility, y = ModernC)) + 
  geom_point(size = 2.5) +
  ggtitle("Fertility Rate vs Modern Contraception %") +
  labs(x = "Fertility Rate (expected # of children)",
       y = "Access to Contraception (%)",
       subtitle = "Fig. 6.2") +
  theme(plot.title = element_text(size = 18, face = "bold"),
        axis.title = element_text(size = 17),
        axis.text = element_text(size=18))

lPPgdpModc <- ggplot(data = UN3_rmna, aes(x = log(PPgdp), y = ModernC)) +
  geom_point(size = 2.5) +
  ggtitle("Per Capita GDP vs Modern Contraception %") +
  labs(x = "Per Capita GDP (USD)",
       y = "Access to Contraception (%)",
       subtitle = "Fig. 6.3") +
  theme(plot.title = element_text(size = 18, face = "bold"),
        axis.title = element_text(size = 17),
          axis.text = element_text(size=18))

SChangeModc <- ggplot(data = UN3_rmna,
                      aes(x = Change,
                          y = ModernC)) +
  geom_point(size = 2.5) +
  ggtitle("Population Change vs Modern Contraception %") +
  labs(x = "Population Change (%)",
       y = "Access to Contraception (%)",
       subtitle = "Fig. 6.4") +
  theme(plot.title = element_text(size = 18, face = "bold"),
        axis.title = element_text(size = 17),
          axis.text = element_text(size=18))

grid.arrange(PopModc, ModcFert, lPPgdpModc, SChangeModc, ncol = 2)

avPlots(PostXTMod)

par(mfrow=c(2,2))
plot(PostXTMod, ask = FALSE)


```

7. Given the selected transformations of the predictors, select a transformation of the response using `MASS::boxcox` or `car::boxCox` and justify.

The Box-Cox method for estimating the maximum likelihood estimate for a power transformation of the response variable, ModernC, produces the curve below. The closest interpretable values to the $95%$ confidence interval are $\frac{1}{2}$ and $1$. A power transformation of $\lambda = 1$ indicates no transformation is needed. Because there seems to be no indication that a $1/2$ power transformation has a higher likelihood than no transformation it is best to leave the response untransformed for ease of interpretation.

```{r Question7, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

boxCox(PostXTMod)

```

8.  Fit the regression using the transformed variables.  Provide residual plots and added variables plots and comment.  If you feel that you need additional transformations of either the response or predictors, repeat any steps until you feel satisfied.

In the summary table for the model we can see that the $\hat \beta$ for log(Pop) is the only $\hat \beta$ that is not significant. For this predictor we cannot reject $H_0: \hat \beta = 0$, so it will be removed from the model. The added variable plots agree with the assessment of the Log(Pop) predictor. 

Diagnostic plots of the predictor/ response relationsips are below. There are clear improvements in these diagnostics after removing the variables for which we could not reject $H_0$. Most notably, the Normal Q-Q plot shows a decrease in the leftward skew of residuals and the leverage values of China and India have decreased as intended on the Residuals vs Leverage plot.

```{r Question8, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

avPlots(PostXTMod)

par(mfrow=c(2,2))
plot(PreTMod, ask = FALSE)


```

9. Start by finding the best transformation of the response and then find transformations of the predictors.  Do you end up with a different model than in 8?

The result of doing the Box-Cox procedure before the Box-Tidwell procedure does not result in a significantly different outcome with regard to theappropriate variable transformations. The only notable difference is that the Confidence interval for the Box-Cox test has moved away from $\lambda = \frac{1}{2}$ and now completely overlaps $\lambda = 1$.


```{r Question9, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

boxCox(PreTMod)
boxTidwell(ModernC ~ PPgdp + Pop + Fertility,
           other.x = ~ Change + Purban + Frate,
           data = UN3_rmna)

```

10.  Are there any outliers or influential points in the data?  Explain.  If so, refit the model after removing any outliers and comment on residual plots.

There are no outlier points in the data

```{r Question10, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

outlierTest(PostXTMod)

ggplot(PostXTMod, aes(x = hatvalues(PostXTMod), y = rstandard(PostXTMod))) + 
  geom_point(size = 4) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  ggtitle("Standardized Residuals vs Leverage") +
  labs(x = "Leverage",
       y = "Standardized Residuals") +
  geom_text(aes(label = ifelse(hatvalues(PostXTMod) > 0.1,
                               names(PostXTMod$resid),
                               ''),
                hjust = 1,vjust = 2)) +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.title = element_text(size = 20),
        axis.text = element_text(size=18))

```

## Summary of Results

11. For your final model, provide summaries of coefficients with 95% confidence intervals in a nice table with interpretations of each coefficient.  These should be in terms of the original units!


```{r Question11, echo = FALSE, warning = FALSE, message = FALSE, fig.width= 14, fig.height= 10}

#SummDF <- data.frame(LowB = round(confint.lm(PostYTMod)[, 1], 2),
#                     HighB = round(confint.lm(PostYTMod)[, 2], 2),
#                     Betas = round(PostYTMod$coefficients, 2),
#                     row.names = names(PostYTMod$coefficients))
#
#kable(SummDF, col.names = c("Coef. Est.", "2.5%", "97.5%"))
#
```


12. Provide a paragraph summarizing your final model and findings suitable for the US envoy to the UN after adjusting for outliers or influential points.   You should provide a justification for any case deletions in your final model


```{r Question12}



```


## Methodology

    
13. Prove that the intercept in the added variable scatter plot will always be zero.  _Hint:  use the fact that if $H$ is the project matrix which contains a column of ones, then $1_n^T (I - H) = 0$.  Use this to show that the sample mean of residuals will always be zero if there is an intercept._


14. For multiple regression with more than 2 predictors, say a full model given by `Y ~ X1 + X2 + ... Xp`   we create the added variable plot for variable `j` by regressing `Y` on all of the `X`'s except `Xj` to form `e_Y` and then regressing `Xj` on all of the other X's to form `e_X`.  Confirm that the slope in a manually constructed added variable plot for one of the predictors  in Ex. 10 is the same as the estimate from your model.
